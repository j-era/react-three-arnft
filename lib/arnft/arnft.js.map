{"version":3,"sources":["../../src/arnft/arnft.js"],"names":["isMobile","setMatrix","workerScript","ARNft","cameraParamUrl","video","renderer","camera","onLoaded","interpolationFactor","inputWidth","videoWidth","inputHeight","videoHeight","matrixAutoUpdate","markerRoot","canvasProcess","document","createElement","contextProcess","getContext","initRenderer","worker","Worker","onmessage","e","onWorkerMessage","postMessage","type","pw","ph","pScale","Math","max","sScale","window","outerWidth","sw","sh","w","h","ox","oy","style","clientWidth","clientHeight","width","height","console","log","setSize","url","root","marker","fillStyle","fillRect","drawImage","imageData","getImageData","imagedata","data","buffer","msg","proj","JSON","parse","ratioW","ratioH","f","n","projectionMatrix","end","process","onFound","onLost","matrixGL_RH","matrix","visible"],"mappings":"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","sourcesContent":["/* eslint-disable camelcase */\nimport { isMobile, setMatrix } from \"./utils\"\n\nconst workerScript = \"./js/arnft.worker.js\"\n\nexport class ARNft {\n  constructor(\n    cameraParamUrl,\n    video,\n    renderer,\n    camera,\n    onLoaded,\n    interpolationFactor,\n  ) {\n    this.inputWidth = video.videoWidth\n    this.inputHeight = video.videoHeight\n\n    this.cameraParamUrl = cameraParamUrl\n    this.video = video\n    this.renderer = renderer\n    this.camera = camera\n    this.onLoaded = onLoaded\n\n    this.camera.matrixAutoUpdate = false\n\n    this.markerRoot = null\n\n    this.canvasProcess = document.createElement(\"canvas\")\n    this.contextProcess = this.canvasProcess.getContext(\"2d\")\n\n    this.initRenderer()\n\n    this.worker = new Worker(workerScript)\n    this.worker.onmessage = (e) => this.onWorkerMessage(e)\n    this.worker.postMessage({\n      type: \"load\",\n      pw: this.pw,\n      ph: this.ph,\n      cameraParamUrl: this.cameraParamUrl,\n      interpolationFactor: interpolationFactor,\n    })\n  }\n\n  initRenderer() {\n    const pScale = 320 / Math.max(this.inputWidth, (this.inputHeight / 3) * 4)\n    const sScale = isMobile() ? window.outerWidth / this.inputWidth : 1\n\n    const sw = this.inputWidth * sScale\n    const sh = this.inputHeight * sScale\n\n    this.w = this.inputWidth * pScale\n    this.h = this.inputHeight * pScale\n\n    this.pw = Math.max(this.w, (this.h / 3) * 4)\n    this.ph = Math.max(this.h, (this.w / 4) * 3)\n\n    this.ox = (this.pw - this.w) / 2\n    this.oy = (this.ph - this.h) / 2\n\n    this.canvasProcess.style.clientWidth = this.pw + \"px\"\n    this.canvasProcess.style.clientHeight = this.ph + \"px\"\n    this.canvasProcess.width = this.pw\n    this.canvasProcess.height = this.ph\n\n    console.log(\n      \"processCanvas:\",\n      this.canvasProcess.width,\n      this.canvasProcess.height,\n    )\n\n    this.renderer.setSize(sw, sh, false) // false -> do not update css styles\n  }\n\n  addMarker(url, root) {\n    root.matrixAutoUpdate = false\n\n    this.markerRoot = root\n    this.worker.postMessage({ type: \"addMarker\", marker: \"../\" + url })\n  }\n\n  process() {\n    this.contextProcess.fillStyle = \"black\"\n    this.contextProcess.fillRect(0, 0, this.pw, this.ph)\n    this.contextProcess.drawImage(\n      this.video,\n      0,\n      0,\n      this.inputWidth,\n      this.inputHeight,\n      this.ox,\n      this.oy,\n      this.w,\n      this.h,\n    )\n\n    const imageData = this.contextProcess.getImageData(0, 0, this.pw, this.ph)\n    this.worker.postMessage({ type: \"process\", imagedata: imageData }, [\n      imageData.data.buffer,\n    ])\n  }\n\n  onWorkerMessage(e) {\n    const msg = e.data\n    switch (msg.type) {\n      case \"loaded\": {\n        const proj = JSON.parse(msg.proj)\n        const ratioW = this.pw / this.w\n        const ratioH = this.ph / this.h\n        const f = 2000.0\n        const n = 0.1\n\n        proj[0] *= ratioW\n        proj[5] *= ratioH\n        proj[10] = -(f / (f - n))\n        proj[14] = -((f * n) / (f - n))\n\n        setMatrix(this.camera.projectionMatrix, proj)\n\n        this.onLoaded(msg)\n        break\n      }\n      case \"markerAdded\": {\n        if (msg.end === true) {\n          console.log(msg)\n        }\n        this.process()\n        break\n      }\n      case \"found\": {\n        console.log(\"found\", msg)\n        this.onFound(msg)\n        break\n      }\n      case \"lost\": {\n        console.log(\"lost\", msg)\n        this.onLost(msg)\n        break\n      }\n      case \"processNext\": {\n        this.process()\n        break\n      }\n    }\n  }\n\n  onFound(msg) {\n    const { matrixGL_RH } = msg\n\n    const matrix = JSON.parse(matrixGL_RH)\n\n    this.markerRoot.visible = true\n    setMatrix(this.markerRoot.matrix, matrix)\n  }\n\n  onLost(msg) {\n    this.markerRoot.visible = false\n  }\n}\n"],"file":"arnft.js"}